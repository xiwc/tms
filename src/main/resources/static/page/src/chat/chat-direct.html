<template>
    <require from="./chat-direct.css"></require>
    <require from="./md-github.css"></require>
    <require from="dropzone/dist/basic.css"></require>
    <require from="swipebox/src/css/swipebox.min.css"></require>
    <require from="simplemde/dist/simplemde.min.css"></require>
    <require from="highlight/styles/github.css"></require>
    <require from="resources/elements/em-confirm-modal"></require>
    <require from="resources/elements/em-chat-input"></require>
    <div ref="chatContainerRef" class="tms-chat-direct">
        <div class="ui top fixed menu">
            <!-- <div class="item">
                <i class="icon link sidebar"></i>
            </div> -->
            <div ref="chatToDropdownRef" class="ui dropdown link item ${isActiveSearch ? 'tms-hide' : ''} tms-chat-at">
                <i class="big loading at icon"></i>
                <span class="text"></span>
                <i class="dropdown icon"></i>
                <div class="menu">
                    <div class="ui icon search input">
                        <i class="search icon"></i>
                        <input ref="filterChatToUser" type="text" placeholder="过滤私聊对象">
                    </div>
                    <div class="divider"></div>
                    <div class="header">
                        <i class="user icon"></i> 切换私聊对象(Ctrl+k)
                    </div>
                    <div class="scrolling menu">
                        <a repeat.for="item of users" task.bind="initChatToDropdownHandler($last)" href="#/chat/@${item.username}" class="item" title="${item.username}" data-value="${item.username}">
                            <i class="circular icon user"></i> ${item.name}
                        </a>
                    </div>
                </div>
            </div>
            <div class="right menu">
                <div class="item tms-item">
                    <button click.delegate="sibebarRightHandler()" title="右侧边栏(Ctrl+.)" class="basic ${isRightSidebarShow ? 'active' : ''} ui icon button">
                        <i class="columns icon"></i>
                    </button>
                </div>
                <!-- <div class="item tms-item">
                    <button click.delegate="starHandler()" title="收藏消息" class="basic ${isStarShow ? 'active' : ''} ui icon button">
                        <i class="empty star icon"></i>
                    </button>
                </div> -->
                <div class="item">
                    <div ref="searchRef" class="ui search">
                        <div class="ui left icon input">
                            <input ref="searchInputRef" keyup.trigger="searchKeyupHandler($event)" focusout.trigger="searchFocusoutHandler()" focusin.trigger="searchFocusinHandler()" class="prompt" type="text" placeholder="搜索...">
                            <i class="${(searchingP && searchingP.readyState != 4) ? 'spinner loading' : 'search'} icon"></i>
                            <i ref="searchRemoveRef" click.delegate="clearSearchHandler()" class="remove link icon"></i>
                        </div>
                    </div>
                </div>
                <a class="item tms-login-user">
                    <i class="circular user icon"></i> ${loginUser.name}
                </a>
            </div>
        </div>
        <div ref="sidebarRef" class="ui left visible segment sidebar tms-left-sidebar">
            <div class="tms-header">
                <h1 class="ui header"><a href="/admin/dynamic?scroll=1">私聊频道</a></h1>
                <input value.bind="filter" focusin.trigger="chatToUserFilerFocusinHanlder()" keyup.trigger="chatToUserFilerKeyupHanlder($event)" type="text" placeholder="私聊对象查找">
                <i title="清空过滤输入" click.delegate="clearFilterHandler()" class="bordered close icon link small"></i>
            </div>
            <div ref="userListRef" class="ui middle aligned selection list">
                <a repeat.for="item of users" title="${item.username}" show.bind="!item.hidden" href="#/chat/@${item.username}" class="item ${item.username == chatTo ? 'active' : ''}" data-id="${item.username}">
                    <i class="circular icon user"></i>
                    <div class="content">
                        <div style="color: black;">${item.name ? item.name : item.username}</div>
                    </div>
                </a>
            </div>
        </div>
        <div ref="contentRef" class="tms-content ${isRightSidebarShow ? 'tms-sidebar-show' : ''}">
            <div ref="contentBodyRef" class="tms-content-body">
                <div ref="commentsRef" class="ui basic segment minimal selection list segment comments">
                    <button if.bind="!last" click.delegate="lastMoreHandler()" class="fluid basic ui button tms-pre-more"><i show.bind="lastMoreP && lastMoreP.readyState != 4" class="spinner loading icon"></i> 加载更多(${lastCnt})</button>
                    <div repeat.for="item of chats" swipebox class="comment item ${item.id == markId ? 'active' : ''}" data-id="${item.id}">
                        <a class="avatar">
                            <i class="circular icon large user"></i>
                        </a>
                        <div class="content">
                            <a class="author">${item.creator.name}</a>
                            <div class="metadata">
                                <div class="date" data-timeago="${item.createDate}" title="${item.createDate | date}">${item.createDate | timeago}</div>
                            </div>
                            <div show.bind="!item.isEditing" class="text markdown-body" innerhtml.bind="item.contentMd"></div>
                            <textarea ref="editTxtRef" pastable autosize dropzone keydown.trigger="eidtKeydownHandler($event, item, editTxtRef)" show.bind="item.isEditing" value.bind="item.content" class="tms-edit-textarea" rows="1"></textarea>
                            <div show.bind="item.isEditing" class="ui compact icon buttons tms-edit-actions">
                                <button click.delegate="editOkHandler($event, item, editTxtRef)" title="保存 (ctrl+enter)" class="ui left attached compact icon button">
                                    <i class="checkmark icon"></i>
                                </button>
                                <button click.delegate="editCancelHandler($event, item, editTxtRef)" title="取消 (esc)" class="ui attached compact icon button">
                                    <i class="remove icon"></i>
                                </button>
                                <button dropzone="clickable.bind: !0; target.bind: editTxtRef" title="上传 (ctrl+u)" class="ui right attached compact icon button">
                                    <i class="upload icon"></i>
                                </button>
                            </div>
                            <div class="actions">
                                <a if.bind="item.creator.username == loginUser.username" click.delegate="editHandler(item, editTxtRef)" class="tms-edit">编辑</a>
                                <a if.bind="item.creator.username == loginUser.username" click.delegate="deleteHandler(item)" class="tms-delete">删除</a>
                                <a class="tms-copy tms-clipboard" data-clipboard-text="${item.content}">复制</a>
                                <a class="tms-share tms-clipboard" data-clipboard-text="${selfLink + '?id=' + item.id}">分享</a>
                            </div>
                        </div>
                    </div>
                    <button if.bind="!first" click.delegate="firstMoreHandler()" class="fluid basic ui button tms-next-more"><i show.bind="nextMoreP && nextMoreP.readyState != 4" class="spinner loading icon"></i> 加载更多(${firstCnt})</button>
                </div>
                <em-chat-input chat-to.bind="chatTo" poll.bind="poll" em-chat-input.ref="emChatInputRef"></em-chat-input>
            </div>
            <div ref="rightSidebarRef" class="tms-right-sidebar">
                <div class="panel-search">
                    <div class="ui basic segment minimal selection list segment comments">
                        <h1 show.bind="!searchChats.length" class="ui center aligned header">无符合检索结果</h1>
                        <div repeat.for="item of searchChats" mouseleave.trigger="searchItemMouseleaveHandler(item)" mouseenter.trigger="searchItemMouseenterHandler(item)" swipebox class="comment item ${item.id == markId ? 'active' : ''}" data-id="${item.id}">
                            <a class="avatar">
                                <i class="circular icon large user"></i>
                            </a>
                            <div class="content">
                                <a class="author">${item.creator.name}</a>
                                <div class="metadata">
                                    <div class="date" data-timeago="${item.createDate}" title="${item.createDate | date}">${item.createDate | timeago}</div>
                                </div>
                                <div class="text markdown-body ${item.isOpen ? 'tms-open' : ''}" innerhtml.bind="item.contentMd"></div>
                                <div class="actions">
                                    <a click.delegate="gotoChatHandler(item)" class="tms-goto" href="">定位</a>
                                    <a class="tms-copy tms-clipboard" data-clipboard-text="${item.content}">复制</a>
                                    <a class="tms-share tms-clipboard" data-clipboard-text="${selfLink + '?id=' + item.id}">分享</a>
                                </div>
                            </div>
                            <div class="tms-btn-open-search-item" click.delegate="openSearchItemHandler(item)">
                                <i title="${item.isOpen ? '点击收起 (o)' : '点击展开 (o)'}" class="angle double ${item.isOpen ? 'up' : 'down'} large icon"></i>
                            </div>
                        </div>
                        <button if.bind="!lastSearch" click.delegate="searchMoreHandler()" class="fluid ui basic button tms-search-more"><i show.bind="searchMoreP && searchMoreP.readyState != 4" class="spinner loading icon"></i> 加载更多(${moreSearchCnt})</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <em-confirm-modal em-confirm-modal.ref="emConfirmModal"></em-confirm-modal>
</template>
