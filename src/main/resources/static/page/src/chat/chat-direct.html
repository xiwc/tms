<template>
    <require from="./chat-direct.css"></require>
    <require from="./md-github.css"></require>
    <require from="dropzone/dist/basic.css"></require>
    <require from="swipebox/src/css/swipebox.min.css"></require>
    <require from="resources/elements/em-confirm-modal"></require>
    <require from="resources/elements/em-hotkeys-modal"></require>
    <div ref="chatContainerRef" class="tms-chat-direct">
        <div class="ui top fixed menu">
            <!-- <div class="item">
                <i class="icon link sidebar"></i>
            </div> -->
            <!-- <a class="item header">私聊@${user.name ? user.name : chatTo}</a> -->
            <div ref="chatToDropdownRef" class="ui dropdown link item">
                <!-- <span style="font-weight: bold; font-size: 20px;">私聊</span> -->
                <i class="big loading at icon"></i>
                <!-- <i class="big icons">
                    <i class="large loading sun icon"></i>
                    <i class="at icon"></i>
                </i> -->
                <span class="text"></span>
                <i class="dropdown icon"></i>
                <div class="menu">
                    <div class="ui icon search input">
                        <i class="search icon"></i>
                        <input type="text" placeholder="过滤私聊对象">
                    </div>
                    <div class="divider"></div>
                    <div class="header">
                        <i class="user icon"></i> 切换私聊对象
                    </div>
                    <div class="scrolling menu">
                        <a repeat.for="item of users" task.bind="initChatToDropdownHandler($last)" href="#/chat-direct/${item.username}" class="item" title="${item.username}" data-value="${item.username}">
                            <i class="circular icon user"></i> ${item.name}
                        </a>
                    </div>
                </div>
            </div>
            <div class="right menu">
                <a class="item">
                    <i class="circular user icon"></i> ${loginUser.name}
                </a>
            </div>
        </div>
        <div ref="sidebarRef" class="ui left visible segment sidebar tms-left-sidebar">
            <div class="tms-header">
                <h1 class="ui header"><a href="/admin/dynamic?scroll=1">私聊频道</a></h1>
                <input value.bind="filter" focusin.trigger="chatToUserFilerFocusinHanlder()" keyup.trigger="chatToUserFilerKeyupHanlder($event)" type="text" placeholder="私聊对象查找">
                <i title="清空过滤输入" click.delegate="clearFilterHandler()" class="bordered close icon link small"></i>
            </div>
            <div ref="userListRef" class="ui middle aligned selection list">
                <a repeat.for="item of users" title="${item.username}" show.bind="!item.hidden" href="#/chat-direct/${item.username}" class="item ${item.username == chatTo ? 'active' : ''}" data-id="${item.username}">
                    <i class="circular icon user"></i>
                    <div class="content">
                        <div style="color: black;">${item.name ? item.name : item.username}</div>
                    </div>
                </a>
            </div>
        </div>
        <div class="tms-content">
            <div class="tms-col w65">
                <div ref="commentsRef" class="ui basic segment minimal selection list segment comments">
                    <!-- <h3 class="ui dividing header">私聊内容</h3> -->
                    <button if.bind="!last" click.delegate="lastMoreHandler()" class="fluid ui button">加载更多(${lastCnt})</button>
                    <div repeat.for="item of chats" swipebox class="comment item ${item.id == markId ? 'active' : ''}" data-id="${item.id}">
                        <a class="avatar">
                            <i class="circular icon large user"></i>
                        </a>
                        <div class="content">
                            <a class="author">${item.creator.name}</a>
                            <div class="metadata">
                                <div class="date" data-timeago="${item.createDate}" title="${item.createDate | date}">${item.createDate | timeago}</div>
                            </div>
                            <div show.bind="!item.isEditing" class="text markdown-body" innerhtml.bind="item.contentMd"></div>
                            <textarea ref="editTxtRef" pastable autosize focusout.trigger="focusoutHandler(item)" keydown.trigger="eidtKeydownHandler($event, item, editTxtRef)" show.bind="item.isEditing" value.bind="item.content" class="tms-edit-textarea" rows="1"></textarea>
                            <div class="actions">
                                <a if.bind="item.creator.username == loginUser.username" click.delegate="editHandler(item, editTxtRef)" class="tms-edit">编辑</a>
                                <a if.bind="item.creator.username == loginUser.username" click.delegate="deleteHandler(item)" class="tms-delete">删除</a>
                                <a class="tms-copy tms-clipboard" data-clipboard-text="${item.content}">复制</a>
                                <a class="tms-share tms-clipboard" data-clipboard-text="${selfLink + '?id=' + item.id}">分享</a>
                            </div>
                        </div>
                    </div>
                    <button if.bind="!first" click.delegate="firstMoreHandler()" class="fluid ui button">加载更多(${firstCnt})</button>
                </div>
                <div class="ui basic segment tms-msg-input dropzone">
                    <div ref="inputRef" class="ui left action fluid icon input dropzone">
                        <div ref="chatBtnRef" class="ui icon button">
                            <i class="plus icon"></i>
                        </div>
                        <div class="ui flowing popup bottom left transition hidden">
                            <div class="ui middle aligned selection list">
                                <div ref="btnItemUploadRef" class="item">
                                    <i class="upload icon"></i>
                                    <div class="content">
                                        上传文件
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea ref="chatInputRef" placeholder="输入聊天内容(按下 / 键提示补全)" pastable autosize value.bind="content" keydown.trigger="sendKeydownHandler($event, chatInputRef)" rows="1"></textarea>
                        <i click.delegate="sendChatMsgHandler()" title="发送消息(Enter)" class="send link icon"></i>
                    </div>
                    <div ref="uploadProgressRef" class="tms-upload-progress dropzone-previews"></div>
                </div>
            </div>
            <!-- <div class="tms-col w35"></div> -->
        </div>
    </div>
    <div ref="previewTemplateRef" style="display: none;">
        <div class="dz-preview dz-file-preview">
            <div class="dz-details">
                <div class="dz-filename"><span data-dz-name></span></div>
                <div class="dz-size" data-dz-size></div>
                <img data-dz-thumbnail />
            </div>
            <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
            <div class="dz-success-mark"><span>✔</span></div>
            <div class="dz-error-mark"><span>✘</span></div>
            <div class="dz-error-message"><span data-dz-errormessage></span></div>
        </div>
    </div>
    <em-confirm-modal em-confirm-modal.ref="emConfirmModal"></em-confirm-modal>
    <em-hotkeys-modal em-hotkeys-modal.ref="emHotkeysModal"></em-hotkeys-modal>
</template>
