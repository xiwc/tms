<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html lang="zh-cn" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <base th:href="@{/}" href="">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>TMS-沟通动态</title>
    <link rel="icon" th:href="@{/favicon.ico}" href="../../static/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" th:href="@{/favicon.ico}" href="../../static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" th:href="@{/lib/semantic/semantic.min.css}" href="../../static/lib/semantic/semantic.min.css" />
    <link rel="stylesheet" th:href="@{/lib/toastr/toastr.css}" href="../../static/lib/toastr/toastr.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/admin/css/md-github.css}" href="../../static/admin/css/md-github.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/lib/simplemde/simplemde.min.css}" href="../../static/lib/simplemde/simplemde.min.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/lib/awesome/css/font-awesome.min.css}" href="../../static/lib/awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/lib/highlight/styles/github.css}" href="../../static/lib/highlight/styles/github.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/lib/dropzone/basic.min.css}" href="../../static/lib/dropzone/basic.min.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/admin/css/admin.css}" href="../../static/admin/css/admin.css" />
    <style>
    .main.container {
        margin-right: 460px !important;
        margin-left: 3em !important;
        width: auto !important;
        max-width: 960px !important;
        padding: 2em 0em 7em;
        position: relative;
    }
    
    .main.container .right.rail {
        margin-left: 3em;
        padding-top: 2em;
        width: 420px;
        /*overflow: auto;*/
    }
    
    .main.container .right.rail .sticky {
        /*max-height: 400px;*/
        overflow: auto;
        padding-left: 5px;
        padding-right: 5px;
    }
    
    .CodeMirror,
    .CodeMirror-scroll {
        min-height: 150px;
    }
    
    .CodeMirror-fullscreen,
    .editor-preview-side.editor-preview-active-side {
        z-index: 999;
    }
    
    .avatar.ui.mini.circular.image {
        cursor: pointer;
    }
    
    .ui.feed>.event:hover,
    .ui.comments .comment:hover,
    .ui.comments .comment.marked {
        background-color: #F3F3F3;
        -webkit-box-shadow: 0 0 5px 1px #0CC!important;
        -moz-box-shadow: 0 0 5px 1px #0CC!important;
        box-shadow: 0 0 5px 1px #0CC!important;
    }
    
    .ui.comments .comment .text {
        margin-top: 0.5em;
    }
    
    .ui.feed>.event>.content .summary {
        /*font-size: 0.9em;*/
    }
    
    .ui.comments .comment .text span.at-user,
    .pp-translate .ui.items>.item>.content>.description .at-user {
        cursor: pointer;
    }
    
    .ui.comments .comment a.author {
        color: #4183c4;
    }
    
    .ui.vertical.icon.buttons.btns-scroll {
        position: fixed;
        right: 433px;
        /* bottom: 225px; */
        bottom: 325px;
        background-color: transparent;
        z-index: 1;
    }
    
    .ui.button.btn-get-chat-news {
        display: none;
        position: fixed;
        right: 430px;
        /* bottom: 300px; */
        bottom: 400px;
        background-color: rgba(219, 40, 40, 0.54);
        z-index: 1;
    }
    
    .ui.button.btn-get-chat-news:hover {
        background-color: rgba(219, 40, 40, 1);
    }
    
    .ui.vertical.icon.buttons.btns-scroll .button {
        border-radius: 10em!important;
        background-color: rgba(224, 225, 226, 0.54);
    }
    
    .ui.vertical.icon.buttons.btns-scroll .button:hover {
        background-color: rgba(224, 225, 226, 1);
    }
    /* 翻译popup样式 start*/
    
    .pp-translate .meta {
        border-top: 1px lightgray solid;
        border-bottom: 1px lightgray solid;
        padding-top: 5px;
        padding-bottom: 5px;
    }
    
    .pp-translate .extra {
        border-top: 1px lightgray solid;
    }
    
    .pp-translate .description {
        border-bottom: 1px lightgray solid;
        padding-bottom: 5px;
    }
    /* 翻译popup样式 end */
    /* chat msg search start */
    
    .chat-search {
        position: fixed;
        top: 50px;
        right: 433px;
        z-index: 1;
        /* display: none; */
        /* width: 30px; */
    }
    
    .ui.search.sh-search {
        /* display: none; */
    }
    
    .ui.circular.icon.button.btn-chat-search {
        margin-right: 0px;
    }
    
    .ui.icon.btn-search.circular.button {
        margin-right: 0;
    }
    
    .chat-search-loc {
        position: fixed;
        top: 50px;
        right: 433px;
        /* z-index: 1; */
        height: 36px;
        width: 1px;
    }
    /* chat msg search end */
    /* 文件上传 start*/
    
    .dz-default.dz-message {
        height: 120px;
        line-height: 120px;
        width: 200px;
        text-align: center;
    }
    
    .editor-toolbar {
        z-index: 2;
    }
    /* 文件上传 end*/
    
    @media only screen and (max-width: 767px) {
        .main.container {
            margin-right: 0 !important;
            margin-left: 0 !important;
            width: auto !important;
            max-width: 960px !important;
            padding: 2em 0em 2em;
            position: relative;
        }
        .main.container .right.rail {
            margin-left: 3em;
            padding-top: 2em;
            width: 420px;
            display: none;
        }
        .ui.vertical.icon.buttons.btns-scroll {
            right: 13px;
            bottom: 190px;
        }
        .ui.button.btn-get-chat-news {
            right: 10px;
            bottom: 265px;
        }
        .chat-search {
            display: none;
        }
    }
    </style>
</head>

<body>
    <div th:replace="admin/index :: sidebar-menu"></div>
    <div th:replace="admin/index :: top-fixed-menu"></div>
    <div class="pusher ad-index-content" style="padding-top: 40px; padding-bottom: 0;">
        <div class="ad-index-container">
            <div th:replace="admin/index :: rail-menu"></div>
            <div id="context">
                <!-- <div th:replace="admin/template :: ad-page-header ('沟通动态', 'dynamic')"></div> -->
                <div class="main ui container">
                    <div class="ui dividing right rail" style="min-height: 279px; padding-left: 1rem;">
                        <div class="ui sticky sy-dynamic" style="z-index: 0; top: 0px; padding-bottom: 20px;">
                            <h4 class="ui dividing header">动态</h4>
                            <div class="ui feed fd-dynamic">
                                <div class="event" th:each="l : ${logs}" th:attr="data-id=${l.id}">
                                    <div class="label">
                                        <a class="avatar ui mini circular image" style="width: 35px; height: 35px; font-size: 35px; background-color: rgba(150, 178, 183, 0.4); text-align: center;">
                                            <span style="display: inline-block; height: 35px; line-height: 35px; vertical-align: top;" th:if="${not #strings.isEmpty(l.creator.name)}" th:text="${#strings.toUpperCase(#strings.substring(l.creator.name,#strings.length(l.creator.name) - 1,#strings.length(l.creator.name)))}">管理员</span>
                                            <img th:if="${#strings.isEmpty(l.creator.name)}" th:src="@{/img/head.png}" src="../../static/img/head.png">
                                        </a>
                                    </div>
                                    <div class="content">
                                        <div class="summary">
                                            <a class="user" th:attr="data-value=${l.creator.username}" th:text="${#strings.isEmpty(l.creator.name) ? l.creator.username : l.creator.name}">张三</a>
                                            <span th:if="${#strings.toString(l.action) == 'Create'}">添加</span>
                                            <span th:if="${#strings.toString(l.action) == 'Update'}">更新</span>
                                            <span th:if="${#strings.toString(l.action) == 'Delete'}">删除</span>
                                            <a th:if="${#strings.toString(l.target) == 'Translate'}" target="_blank" th:href="@{/admin/translate(id=${l.targetId})}" th:text="${'翻译#' + l.targetId}">翻译</a>
                                            <span th:if="${#strings.toString(l.properties) == 'TranslateItem'}">内容</span>
                                            <span th:if="${#strings.toString(l.properties) == 'Key'}">名称</span>
                                            <span th:if="${#strings.toString(l.properties) == 'Watchers'}">关注者</span>
                                            <span th:if="${#strings.toString(l.properties) == 'Labels'}">标签</span>
                                            <div class="date" th:text="${#calendars.format(l.createDate,'yyyy/MM/dd HH:mm:ss')}">
                                                1 Hour Ago
                                            </div>
                                        </div>
                                        <div th:unless="${#strings.isEmpty(l.properties)}" class="extra text">
                                            <div style="word-break: break-all; font-size: .85714286rem; color: rgba(0,0,0,.6);" th:unless="${#strings.isEmpty(l.oldValue)}" th:text="${l.oldValue}"></div>
                                            <div class="divider fitted horizontal ui" style="color: green; font-size: 12px; font-weight: bold;" th:unless="${#strings.isEmpty(l.oldValue)}">更新为</div>
                                            <div th:if="${#strings.toString(l.properties) == 'Labels'}" class="ui tag label" th:text="${l.newValue}"></div>
                                            <div th:if="${#strings.toString(l.properties) == 'Watchers'}" class="ui label">
                                                <i class="user icon"></i> <span th:text="${l.newValue}"></span>
                                            </div>
                                            <div style="word-break: break-all; font-size: .85714286rem; color: rgba(0,0,0,.6);" th:unless="${#strings.toString(l.properties) == 'Labels' or #strings.toString(l.properties) == 'Watchers'}" th:text="${l.newValue}"></div>
                                        </div>
                                        <!-- <div class="extra images">
                                            <a><img th:src="@{/img/image.png}" src="../../static/img/image.png"></a>
                                            <a><img th:src="@{/img/image.png}" src="../../static/img/image.png"></a>
                                        </div> -->
                                        <!-- <div class="meta">
                                            <a class="like">
                                                <i class="like icon"></i> 4 Likes
                                            </a>
                                        </div> -->
                                    </div>
                                </div>
                            </div>
                            <button th:unless="${logs.last}" class="fluid ui button btn-log-more">加载更多</button>
                        </div>
                    </div>
                    <div class="chat">
                        <div class="ui minimal comments" style="display:none;">
                            <h3 class="ui dividing header">沟通</h3>
                            <button th:unless="${chats.last}" class="fluid ui button btn-chat-more">加载更多</button>
                            <div class="comment" th:each="c : ${chats}" th:classappend="${(param.containsKey('id') and #strings.equals(param.id[0], c.id)) ? 'marked' : ''}" th:attr="data-id=${c.id}">
                                <a class="avatar ui mini circular image" style="width: 35px; height: 35px; font-size: 35px; background-color: rgba(150, 178, 183, 0.4); text-align: center;">
                                    <span style="display: inline-block; height: 35px; line-height: 35px; vertical-align: top;" th:if="${not #strings.isEmpty(c.creator.name)}" th:text="${#strings.toUpperCase(#strings.substring(c.creator.name,#strings.length(c.creator.name) - 1,#strings.length(c.creator.name)))}">管理员</span>
                                    <img th:if="${#strings.isEmpty(c.creator.name)}" th:src="@{/img/head.png}" src="../../static/img/head.png">
                                </a>
                                <div class="content">
                                    <a class="author" th:attr="data-value=${c.creator.username}" th:text="${#strings.isEmpty(c.creator.name) ? c.creator.username : c.creator.name}">Matt</a>
                                    <div class="metadata">
                                        <span class="date" th:text="${#calendars.format(c.createDate,'yyyy/MM/dd HH:mm:ss')}">Today at 5:42PM</span>
                                        <div class="rating">
                                            <i style="cursor: pointer;" title="赞一下" class="thumbs outline up icon" data-type="zan" data-label="赞"></i> <span th:unless="${#strings.isEmpty(c.voteZan)}" th:title="${c.voteZan}" th:text="${#arrays.length(#strings.arraySplit(c.voteZan,',')) + ' 赞'}">5 赞</span>
                                        </div>
                                        <div class="rating">
                                            <i style="cursor: pointer;" title="踩一下" class="thumbs outline down icon" data-type="cai" data-label="踩"></i> <span th:unless="${#strings.isEmpty(c.voteCai)}" th:title="${c.voteCai}" th:text="${#arrays.length(#strings.arraySplit(c.voteCai,',')) + ' 踩'}">5 踩</span>
                                        </div>
                                    </div>
                                    <div class="text markdown-body" th:text="${c.content}">
                                        How artistic!
                                    </div>
                                    <div class="actions" th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')') or (c.creator.username == user.username)}">
                                        <a class="reply">回复</a>
                                        <a class="edit">编辑</a>
                                        <a class="delete">删除</a>
                                    </div>
                                </div>
                            </div>
                            <button th:unless="${chats.first}" class="fluid ui button btn-chat-pre-more">加载更多</button>
                            <form class="ui reply form fm-reply">
                                <div class="field markdown-body pp-users">
                                    <textarea autofocus="autofocus" class="ta-md"></textarea>
                                </div>
                                <div class="ui fluid popup bottom left transition hidden list-users-container" style="max-height:150px; overflow:auto;">
                                    <div class="ui middle aligned selection list list-users">
                                        <div class="item" th:attr="data-value=${'all'}, data-label=${'全部用户'}">
                                            <a class="avatar ui mini circular image" style="width: 35px; height: 35px; font-size: 35px; background-color: rgba(150, 178, 183, 0.4); text-align: center; padding-right: 0px;">
                                                <span style="display: inline-block; height: 35px; line-height: 35px; vertical-align: top;" th:text="${'全'}">全部用户</span>
                                            </a>
                                            <div class="content">
                                                <div class="header" th:text="${'全部用户 - (all)'}">全部用户 - (all)</div>
                                            </div>
                                        </div>
                                        <div class="item" th:each="u : ${users}" th:attr="data-value=${u.username}, data-label=${#strings.isEmpty(u.name) ? u.username : u.name}">
                                            <!-- <img class="ui avatar image" th:src="@{/img/head.png}" src="/images/avatar/small/helen.jpg"> -->
                                            <a class="avatar ui mini circular image" style="width: 35px; height: 35px; font-size: 35px; background-color: rgba(150, 178, 183, 0.4); text-align: center; padding-right: 0px;">
                                                <span style="display: inline-block; height: 35px; line-height: 35px; vertical-align: top;" th:if="${not #strings.isEmpty(u.name)}" th:text="${#strings.toUpperCase(#strings.substring(u.name,#strings.length(u.name) - 1,#strings.length(u.name)))}">管理员</span>
                                                <img style="height:35px;" th:if="${#strings.isEmpty(u.name)}" th:src="@{/img/head.png}" src="../../static/img/head.png">
                                            </a>
                                            <div class="content">
                                                <div class="header" th:text="${(#strings.isEmpty(u.name) ? u.username : u.name) + ' - ' + u.mails + ' (' + u.username + ')'}">张三 - weicheng.xi@newtouch.cn (xiweicheng)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui buttons">
                                    <button class="ui button btn-chat-clear">取消</button>
                                    <div class="or"></div>
                                    <button class="ui positive button btn-chat-submit">提交</button>
                                </div>
                                <a th:href="@{/admin/dynamic(scroll=${'1'})}" title="刷新消息" class="pp-not ui black circular icon right floated button">
                                    <i class="refresh icon"></i>
                                </a>
                            </form>
                        </div>
                        <div class="ui circular red icon button btn-get-chat-news" title="获取新消息">
                            <i class="refresh icon"></i>
                            <div class="floating ui red circular label lbl-chat-news-count">0</div>
                        </div>
                        <div class="ui vertical circular icon buttons btns-scroll">
                            <div class="ui circular icon button btn-scroll-up" title="滚动至顶部">
                                <i class="arrow up icon"></i>
                            </div>
                            <div class="ui circular icon button btn-scroll-down" title="滚动至底部">
                                <i class="arrow down icon"></i>
                            </div>
                        </div>
                        <!-- 沟通消息检索 -->
                        <div class="chat-search">
                            <div class="ui search">
                                <div class="ui circular icon button btn-search" title="沟通消息检索">
                                    <input style="display: none;" class="prompt" th:value="${param.containsKey('search') ? param.search[0] : ''}" type="text" placeholder="查找...">
                                    <i class="search link icon"></i>
                                </div>
                                <div class="results"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- popup container start -->
    <div class="ui flowing popup top left transition hidden pp-translate"></div>
    <div class="chat-search-loc"></div>
    <div class="ui flowing popup top left transition hidden pp-chat-search-results">
        <div class="ui selection divided list list-chat-search-results">
        </div>
    </div>
    <div class="ui flowing popup top left transition hidden pp-chat-upload-file">
        <form action="/admin/file/upload" class="dropzone">
            <div class="fallback">
                <input name="file" type="file" multiple />
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </div>
    <!-- popup container end -->
    <div th:replace="admin/template :: ad-handle-confirm"></div>
    <div th:replace="admin/template :: ad-delete-confirm"></div>
    <div th:replace="admin/template :: ad-chat-edit"></div>
    <div th:include="admin/template :: ad-page-common"></div>
    <div th:replace="admin/template :: ad-page-dimmer"></div>
    <div th:replace="admin/template :: chatMoreTpl"></div>
    <div th:replace="admin/template :: logMoreTpl"></div>
    <div th:replace="admin/template :: tansPpTpl"></div>
    <div th:replace="admin/template :: chatMsgPpTpl"></div>
    <div th:replace="admin/template :: chatSearchTpl"></div>
    <input type="hidden" name="page.number" th:value="${chats.number}" />
    <input type="hidden" name="page.number.next" th:value="${chats.number + 1}" />
    <input type="hidden" name="page.number.pre" th:value="${chats.number - 1}" />
    <input type="hidden" name="page.size" th:value="${chats.size}" />
    <input type="hidden" name="page.number.logs" th:value="${logs.number}" />
    <input type="hidden" name="page.number.next.logs" th:value="${logs.number + 1}" />
    <input type="hidden" name="page.size.logs" th:value="${logs.size}" />
    <input type="hidden" name="user.username" th:value="${user.username}" />
    <input type="hidden" name="role.admin" th:value="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" />
    <script type="text/javascript" th:src="@{/lib/jquery-1.11.1.min.js}" src="../../static/lib/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/semantic/semantic.min.js}" src="../../static/lib/semantic/semantic.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/jquery.tablesort.min.js}" src="../../static/lib/jquery.tablesort.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/toastr/toastr.js}" src="../../static/lib/toastr/toastr.js"></script>
    <script type="text/javascript" th:src="@{/lib/showdown.min.js}" src="../../static/lib/showdown.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/simplemde/simplemde.min.js}" src="../../static/lib/simplemde/simplemde.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/jquery.tmpl.min.js}" src="../../static/lib/jquery.tmpl.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/url.min.js}" src="../../static/lib/url.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/scrollTo/jquery.scrollTo.min.js}" src="../../static/lib/scrollTo/jquery.scrollTo.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/highlight/highlight.pack.js}" src="../../static/lib/highlight/highlight.pack.js"></script>
    <script type="text/javascript" th:src="@{/lib/paste.min.js}" src="../../static/lib/paste.min.js"></script>
    <script type="text/javascript" th:src="@{/lib/dropzone/dropzone.min.js}" src="../../static/lib/dropzone/dropzone.min.js"></script>
    <script type="text/javascript" th:src="@{/admin/js/admin.js}" src="../../static/admin/js/admin.js"></script>
    <script type="text/javascript" th:src="@{/admin/js/poll.js}" src="../../static/admin/js/poll.js"></script>
    <script type="text/javascript">
    jQuery(function($) {

        Dropzone.autoDiscover = false;

        // ------------------------------------------------------------------------------------- rating start

        $('body').on('click', '.chat .comments .comment .content .rating i.icon', function(event) {
            event.preventDefault();
            $icon = $(this).removeClass('outline');
            $span = $icon.parent().children('span');

            var chatHtml = $icon.closest('.comment').find('.content .text.markdown-body').html();
            var html = $('<div class="markdown-body"/>').html('<style>.markdown-body{font-size:14px;line-height:1.6}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a.absent{color:#C00}.markdown-body a.anchor{bottom:0;cursor:pointer;display:block;left:0;margin-left:-30px;padding-left:30px;position:absolute;top:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{cursor:text;font-weight:700;margin:20px 0 10px;padding:0;position:relative}.markdown-body h1 .mini-icon-link,.markdown-body h2 .mini-icon-link,.markdown-body h3 .mini-icon-link,.markdown-body h4 .mini-icon-link,.markdown-body h5 .mini-icon-link,.markdown-body h6 .mini-icon-link{color:#000;display:none}.markdown-body h1:hover a.anchor,.markdown-body h2:hover a.anchor,.markdown-body h3:hover a.anchor,.markdown-body h4:hover a.anchor,.markdown-body h5:hover a.anchor,.markdown-body h6:hover a.anchor{line-height:1;margin-left:-22px;padding-left:0;text-decoration:none;top:15%}.markdown-body h1:hover a.anchor .mini-icon-link,.markdown-body h2:hover a.anchor .mini-icon-link,.markdown-body h3:hover a.anchor .mini-icon-link,.markdown-body h4:hover a.anchor .mini-icon-link,.markdown-body h5:hover a.anchor .mini-icon-link,.markdown-body h6:hover a.anchor .mini-icon-link{display:inline-block}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{color:#000;font-size:28px}.markdown-body h2{border-bottom:1px solid #CCC;color:#000;font-size:24px}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h6{color:#777;font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:15px 0}.markdown-body hr{overflow:hidden;background:#e7e7e7;height:4px;padding:0;margin:16px 0;border:0;-moz-box-sizing:content-box;box-sizing:content-box}.markdown-body h1+p,.markdown-body h2+p,.markdown-body h3+p,.markdown-body h4+p,.markdown-body h5+p,.markdown-body h6+p,.markdown-body ol li>:first-child,.markdown-body ul li>:first-child{margin-top:0}.markdown-body hr:after{clear:both}.markdown-body a:first-child h1,.markdown-body a:first-child h2,.markdown-body a:first-child h3,.markdown-body a:first-child h4,.markdown-body a:first-child h5,.markdown-body a:first-child h6,.markdown-body>h1:first-child,.markdown-body>h1:first-child+h2,.markdown-body>h2:first-child,.markdown-body>h3:first-child,.markdown-body>h4:first-child,.markdown-body>h5:first-child,.markdown-body>h6:first-child{margin-top:0;padding-top:0}.markdown-body li p.first{display:inline-block}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol.no-list,.markdown-body ul.no-list{list-style-type:none;padding:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0}.markdown-body dl{padding:0}.markdown-body dl dt{font-size:14px;font-style:italic;font-weight:700;margin:15px 0 5px;padding:0}.markdown-body dl dt:first-child{padding:0}.markdown-body dl dt>:first-child{margin-top:0}.markdown-body dl dt>:last-child{margin-bottom:0}.markdown-body dl dd{margin:0 0 15px;padding:0 15px}.markdown-body blockquote>:first-child,.markdown-body dl dd>:first-child{margin-top:0}.markdown-body blockquote>:last-child,.markdown-body dl dd>:last-child{margin-bottom:0}.markdown-body blockquote{border-left:4px solid #DDD;color:#777;padding:0 15px}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{border:1px solid #CCC;padding:6px 13px}.markdown-body table tr{background-color:#FFF;border-top:1px solid #CCC}.markdown-body table tr:nth-child(2n){background-color:#F8F8F8}.markdown-body img{max-width:100%}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{border:1px solid #DDD;display:block;float:left;margin:13px 0 0;overflow:hidden;padding:7px;width:auto}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}.markdown-body span.align-center{clear:both;display:block;overflow:hidden}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{clear:both;display:block;overflow:hidden}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{background-color:#F8F8F8;border:1px solid #EAEAEA;border-radius:3px;margin:0 2px;padding:0 5px;white-space:nowrap}.markdown-body pre>code{background:none;border:none;margin:0;padding:0;white-space:pre}.markdown-body .highlight pre,.markdown-body pre{background-color:#F8F8F8;border:1px solid #CCC;border-radius:3px;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px}.markdown-body pre code,.markdown-body pre tt{background-color:transparent;border:none}</style>' + chatHtml).wrap('<div/>').parent().html();

            $.post('/admin/chat/vote/unmask', {
                baseURL: baseURL,
                id: $icon.closest('.comment').attr('data-id'),
                type: $icon.attr('data-type'),
                contentHtml: html
            }, function(data, textStatus, xhr) {
                if (data.success) {
                    if ($span.size() == 0) {
                        $span = $('<span>1 ' + $icon.attr('data-label') + '</span>');
                        $icon.parent().append($span);
                    } else {
                        var oArr = $span.text().split(' ');
                        $span.text((parseInt(oArr[0]) + 1) + ' ' + oArr[1]);
                    }
                    $span.attr('title', $icon.attr('data-type') == 'zan' ? data.data.voteZan : data.data.voteCai)
                } else {
                    toastr.error(data.data, "投票失败!");
                }
            });
        });

        // ------------------------------------------------------------------------------------- rating end

        // ------------------------------------------------------------------------------------- chat search start
        $('.chat-search').hover(function() {
            $(this).find('input').show();
            $(this).find('.btn-search').removeClass('circular button').addClass('input');
            $(this).find('input').focus();
        }, function() {
            $(this).find('input').hide();
            $(this).find('.btn-search').removeClass('input').addClass('circular button');
        });
        var source = [];
        if (localStorage) {
            var v = localStorage.getItem('admin/dynamic:search');
            source = v ? $.parseJSON(v) : [];
        }
        $('.chat-search .ui.search').search({
            source: source,
            onSelect: function(result, response) {
                searchHandler();
            },
            onResults: function() {
                $(this).search('hide results');
            }
        });

        function searchHandler() {
            var search = $('.chat-search .ui.search input').val();

            if (!search || search.length < 2) {
                toastr.error('检索条件不能少于2位字符!');
                return;
            }
            // 保存检索值
            var isExists = false;
            $.each(source, function(index, val) {
                if (val.title == search) {
                    isExists = true;
                    return false;
                }
            });
            if (!isExists) {
                source.splice(0, 0, {
                    title: search
                });
                $('.chat-search .ui.search').search({
                    source: source
                });
            }
            localStorage && localStorage.setItem('admin/dynamic:search', JSON.stringify(source));

            // TODO ajax search
            console.log('chat search...');

            $('.btn-search i.icon').popup({
                popup: $('.pp-chat-search-results'),
                hoverable: true,
                on: 'click',
                // context: 'body',
                target: '.btn-search i.icon',
                // inline: true,
                movePopup: false,
                position: 'bottom right',
                closable: false,
                delay: {
                    show: 300,
                    hide: 300
                },
                onShow: function() {
                    var $pp = $(this);
                    $pp.children('.ui.list').html('加载中...');
                    $.get('admin/chat/search/unmask', {
                        search: search
                    }, function(data) {
                        if (data.success) {
                            var chats = data.data.content;
                            if (data.data.content.length == 0) {
                                $pp.children('.ui.list').html('检索结果不存在!');
                                return;
                            }

                            $.each(chats, function(index, chat) {
                                chat.contentBrief = chat.content.length > 50 ? chat.content.substr(0, 47) + '...' : chat.content;
                                if (chat.creator.name) {
                                    chat.iconName = chat.creator.name.substr(chat.creator.name.length - 1).toUpperCase();
                                }
                                var d = new Date(chat.createDate);
                                chat.createDateFormat = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                            });
                            $("#chatSearchTpl").tmpl(chats).appendTo($pp.children('.ui.list').empty());

                        } else {
                            toastr.error(data.data, "加载失败!");
                        }
                    });
                }
            }).popup('show');
        }

        $('.chat-search .ui.search input').keyup(function(event) {
            if (event.keyCode == 13) {
                searchHandler();
            }
        });

        $('.chat-search .ui.search i').click(function(event) {
            searchHandler();
        });

        $('.list-chat-search-results').on('click', '.item', function(event) {
            event.preventDefault();
            $item = $(this);
            $.get('/admin/chat/searchBy', {
                id: $item.attr('data-id')
            }, function(data) {
                if (data.success) {

                    var chats = data.data.content;
                    if (chats.length == 0) {
                        toastr.error("检索结果不存在!");
                        return;
                    }

                    var $btnUp = $('.chat .btn-chat-more');
                    var $btnDown = $('.chat .btn-chat-pre-more');

                    if (data.data.last) {
                        $btnUp.remove();
                        $btnUp = $('.chat .btn-chat-more');
                    } else {
                        if ($btnUp.size() == 0) {
                            $btnUp = $('<button class="fluid ui button btn-chat-more">加载更多</button>');
                            $btnUp.insertAfter('.chat .comments > h3');
                        }

                        $('input:hidden[name="page.number.next"]').val(data.data.number + 1);
                    }

                    if (data.data.first) {
                        $btnDown.remove();
                        $btnDown = $('.chat .btn-chat-pre-more');
                    } else {
                        if ($btnDown.size() == 0) {
                            $btnDown = $('<button class="fluid ui button btn-chat-pre-more">加载更多</button>');
                            $btnDown.insertBefore('.chat .fm-reply')
                        }
                        $('input:hidden[name="page.number.pre"]').val(data.data.number - 1);
                    }

                    $('.chat .comments .comment').remove();

                    $after = $btnUp.size() == 0 ? $('.chat .comments > h3') : $btnUp;

                    var $more = convertChat(chats);
                    $more.insertAfter($after);
                    s2m();
                }
            });
        });

        // ------------------------------------------------------------------------------------- chat search end

        $('table').tablesort().data('tablesort');
        $('.ui.dropdown').dropdown();
        $('.pp').popup();
        $('.pp-users.field').popup({
            inline: true,
            hoverable: true,
            position: 'bottom left',
            distanceAway: -40,
            on: 'manual',
            delay: {
                show: 300,
                hide: 800
            }
        });
        $('.ui.dropdown.dd-actions').dropdown({
            action: 'hide'
        });

        var baseURL = Utils.getBaseURL();
        // 是否第一次调用s2b函数
        var isS2bFirst = true;

        $('.list-users').on('click', '.item', function(event) {
            addAtUser(cm, $(this));
        });

        /**
         * 解析@users
         * @param  {[type]} plainText [description]
         * @return {[type]}           [description]
         */
        function parseUsers(plainText) {
            var users = [];
            var atR = /\{~([^\}]*)\}/g;
            var rs = atR.exec(plainText);
            while (rs) {
                if (userMap[rs[1]] && users.indexOf(rs[1]) == -1) {
                    users.push(rs[1]);
                }
                rs = atR.exec(plainText);
            }

            return users;
        }

        /**
         * 解析要发送邮件的用户们
         * @param  {[type]} plainText [description]
         * @return {[type]}           [description]
         */
        function parseUsernames(plainText) {
            var users = parseUsers(plainText);
            if (users.indexOf('all') > -1) {
                var users2 = [];
                $.each(usernames, function(index, username) {
                    if (username != 'all') {
                        users2.push(username);
                    }
                });
                return users2;
            }
            return users;
        }

        /**
         * 替换@user解析
         * @param  {[type]} plainText [description]
         * @return {[type]}           [description]
         */
        function preParse(plainText) {

            var txt = plainText;
            $.each(parseUsers(plainText), function(index, username) {
                // txt = txt.replace(new RegExp('{~' + username + '}', 'g'), '**`@' + userMap[username] + '`**');
                txt = txt.replace(new RegExp('{~' + username + '}', 'g'), '<span data-value="' + username + '" class="at-user">' + '**`@' + userMap[username] + '`**' + '</span>');
            });

            return txt;
        }

        var simplemdeEdit = new SimpleMDE({
            element: $(".ad-chat-edit textarea")[0],
            autoDownloadFontAwesome: false,
            // autofocus: true,
            previewRender: function(plainText, preview) { // Async method
                setTimeout(function() {
                    preview.innerHTML = simplemdeEdit.markdown(preParse(plainText));
                }, 250);

                return "解释渲染中...";
            },
            autosave: {
                enabled: true,
                delay: 5000,
                uniqueId: "chat-edit-content"
            }
        });

        var simplemde = new SimpleMDE({
            element: $(".ta-md")[0],
            autoDownloadFontAwesome: false,
            autofocus: true,
            toolbar: [
                "bold",
                "italic",
                "strikethrough",
                "heading",
                "heading-smaller",
                "heading-bigger",
                "heading-1",
                "heading-2",
                "heading-3",
                "|",
                "code",
                "quote",
                "unordered-list",
                "ordered-list",
                "clean-block",
                "|",
                "link",
                "image",
                "table",
                "horizontal-rule",
                "|", {
                    name: "upload",
                    action: function(editor) {},
                    className: "fa fa-upload",
                    title: "上传文件",
                }, "|",
                "preview",
                "side-by-side",
                "fullscreen",
                "guide"

            ],
            previewRender: function(plainText, preview) { // Async method
                setTimeout(function() {
                    preview.innerHTML = simplemde.markdown(preParse(plainText));
                }, 250);

                return "解释渲染中...";
            },
            autosave: {
                enabled: true,
                delay: 5000,
                uniqueId: "chat-content"
            }
        });

        simplemde.codemirror.on('keyup', function(cm, e) {
            // console.log(e);
            if (e.ctrlKey && e.keyCode == 13) {
                $('.btn-chat-submit').click();
            }
        });

        $('.fm-reply .editor-toolbar a.fa-upload').popup({
            popup: $('.pp-chat-upload-file'),
            hoverable: true,
            on: 'click',
            position: 'top center',
            closable: false,
            delay: {
                show: 300,
                hide: 300
            },
            onShow: function() {}
        });

        $(".pp-chat-upload-file form.dropzone").dropzone({
            paramName: 'file',
            maxFilesize: 5, // MB
            dictDefaultMessage: '拖拽或点击上传',
            init: function() {
                this.on("success", function(file, data) {
                    if (data.success) {

                        $.each(data.data, function(index, item) {
                            if (item.type == 'Image') {
                                insertComment(cm, '![{name}]({baseURL}{path}{uuidName}) '
                                    .replace(/\{name\}/g, item.name)
                                    .replace(/\{baseURL\}/g, baseURL)
                                    .replace(/\{path\}/g, item.path)
                                    .replace(/\{uuidName\}/g, item.uuidName));
                            } else {
                                insertComment(cm, '[{name}]({baseURL}{path}{uuidName}) '
                                    .replace(/\{name\}/g, item.name)
                                    .replace(/\{baseURL\}/g, baseURL)
                                    .replace(/\{path\}/g, item.path)
                                    .replace(/\{uuidName\}/g, item.uuidName));
                            }
                        });
                        toastr.success('上传成功!');
                    } else {
                        toastr.error(data.data, '上传失败!');
                    }

                });
                this.on("error", function(file, errorMessage, xhr) {
                    toastr.error(errorMessage, '上传失败!');
                });
                this.on("complete", function(file) {
                    this.removeFile(file);
                });
            }
        });

        // ============================================================================ @user start
        // TODO 临时全局变量定义
        var cm = simplemde.codemirror;
        var mk = ' @';
        var usernames = [];
        var userMap = {};
        $('.list-users > .item').each(function(index, el) {
            usernames.push($(el).attr('data-value'));
            userMap[$(el).attr('data-value')] = $(el).attr('data-label');
        });

        var atHandler = function(cm, o) {

            var cursor = cm.getCursor();
            var line = cm.getLine(cursor.line);

            if (line.lastIndexOf('@') == 0) {
                mk = '@';
            } else {
                mk = ' @';
            }

            var mkIndex = line.lastIndexOf(mk);
            var atFrom = mkIndex + mk.length;
            if (mkIndex > -1 && cursor.ch >= atFrom) {

                $('.pp-users').popup('is hidden') && $('.pp-users').popup('show');

                var at = $.trim(line.substr(atFrom).split(' ')[0]);

                if (at) {
                    $.each(usernames, function(index, username) {
                        if (username.indexOf(at) == -1) {
                            $('.list-users > .item[data-value="' + username + '"]').hide();
                        } else {
                            $('.list-users > .item[data-value="' + username + '"]').show();
                        }
                    });
                } else {
                    $('.list-users > .item').each(function(index, el) {
                        $(el).show();
                    });
                }

                var $s = $('.list-users > .item:visible').each(function(index, el) {
                    $(el).removeClass('active');
                }).first().addClass('active');
                $('.list-users-container').scrollTo($s);

            } else {
                $('.pp-users').popup('is visible') && $('.pp-users').popup('hide');
            }

        };

        cm.on('cursorActivity', atHandler);
        // cm.on('change', atHandler);
        cm.on('keydown', function(cm, e) {
            // console.log(e);
            if ($('.pp-users').popup('is visible')) {

                var cnt = $('.list-users > .item:visible').size();
                if (cnt == 0) {
                    return;
                }
                var $selected = $('.list-users > .active.item:visible');
                // var selectIndex = $('.list-users > .item:visible').index('.item.active');
                var selectIndex = $selected.index('.list-users > .item:visible');
                var nextIndex = (selectIndex + 1 + cnt) % cnt;
                var preIndex = (selectIndex - 1 + cnt) % cnt;
                if (e.keyCode == 38) { // key up
                    e.preventDefault();
                    var $s = $('.list-users > .item:visible').each(function(index, el) {
                        $(el).removeClass('active');
                    }).eq(preIndex).addClass('active');
                    $('.list-users-container').scrollTo($s);
                } else if (e.keyCode == 40) { // key down
                    e.preventDefault();
                    var $s = $('.list-users > .item:visible').each(function(index, el) {
                        $(el).removeClass('active');
                    }).eq(nextIndex).addClass('active');
                    $('.list-users-container').scrollTo($s);
                } else if (e.keyCode == 13) { // key enter
                    e.preventDefault();
                    // console.log($selected.attr('data-value'));
                    addAtUser(cm, $selected);
                }
            }

        });

        /**
         * 添加转换选择的@user到编辑器
         * @param {CodeMirror} cm CodeMirror
         */
        function addAtUser(cm, $user) {
            var cursor = cm.getCursor();
            var line = cm.getLine(cursor.line);
            var mkIndex = line.lastIndexOf(mk);
            var atFrom = mkIndex + mk.length;
            if (mkIndex > -1 && cursor.ch >= atFrom) {
                cm.replaceRange('{~' + $user.attr('data-value') + '}', {
                    line: cursor.line,
                    ch: atFrom - 1
                }, {
                    line: cursor.line,
                    ch: cursor.ch
                });
            }

            $('.pp-users').popup('is visible') && $('.pp-users').popup('hide');

            cm.focus();
        }

        function insertAtUser(cm, username) {
            var cursor = cm.getCursor();
            if (cursor) {
                cm.replaceRange('{~' + username + '}', cursor, cursor);
            }
        }

        /**
         * 编辑器插入自定义沟通内容
         * @param  {[type]} cm      [description]
         * @param  {[type]} comment [description]
         * @return {[type]}         [description]
         */
        function insertComment(cm, comment) {
            var cursor = cm.getCursor();
            if (cursor) {
                cm.replaceRange(comment, cursor, cursor);

                s2b();
                cm.focus();
            }
        }

        // ============================================================================ @user end

        // ============================================================================ @chat markdown to html start

        var $textMds = $('.comments .content .text');
        $textMds.each(function(index, el) {
            var html = simplemde.markdown(preParse($(el).text()));
            $(el).html(html).find('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });

        $('.ui.comments').show();

        // ============================================================================ @chat markdown to html end

        // -------------------------------------------------------------------------------- sticky init start
        $('.main.container .right.rail .sticky').css('max-height', $(window).height() - 70);
        // $('.ad-index-container .left.rail.ad-index-rail .sticky').css('max-height', $(window).height() - 70);
        $(window).resize(function(event) {
            $('.main.container .right.rail .sticky').css('max-height', $(window).height() - 70);
            // $('.ad-index-container .left.rail.ad-index-rail .sticky').css('max-height', $(window).height() - 70);
        });
        if ($('.main.container .right.rail').is(':visible')) {
            $('.ui.sticky.sy-dynamic').sticky({
                offset: 70,
                observeChanges: true,
                context: '#context'
            });
        }
        // -------------------------------------------------------------------------------- sticky init end

        // ============================================================================ url? start

        if (url('?scroll') || url('?scroll') == '') {
            s2b();
            cm.focus();
        }

        if (url('?id')) {
            s2m(); // 滚动到标记沟通消息处
        }

        if (url('?at')) {

            simplemde.value(''); // 首先清空编辑器
            var atArr = url('?at').split(',');

            var ats = [];
            $.each(atArr, function(index, at) {
                var _at = '{~{username}}'.replace(/\{username\}/g, at);
                if (ats.indexOf(_at) == -1) {
                    ats.push(_at);
                }
            });
            // [[翻译#173](/admin/dynamic?id=173){~admin} & {~step}]
            // var comment = '### 沟通讨论([翻译#{translateId}](admin/translate?id={translateId}))\n---\n{ats} ';
            var comment = '[[翻译#{translateId}]({baseURL}admin/translate?id={translateId}){ats}]\n\n';
            comment = comment.replace(/\{translateId\}/g, url('?translateId'))
                .replace(/\{baseURL\}/g, baseURL)
                .replace(/\{ats\}/g, ats.join(' & '));
            insertComment(cm, comment);
        }

        // ============================================================================ url? end

        $('.btn-scroll-up').click(function(event) {
            s2t();
        });

        $('.btn-scroll-down').click(function(event) {
            s2b();
        });

        // 滚动到标记处
        function s2m() {

            if (isS2bFirst) { // 解决页面首次加载, 有图片加载比较慢导致没有滚动到顶部问题.
                isS2bFirst = false;
                Utils.imgLoaded($('.chat .ui.comments .comment .text img'), function() {
                    $('html, body, .ad-index-content').scrollTo($(".comments .comment.marked"), 300, {
                        offset: -50
                    });
                });
            } else {
                $('html, body, .ad-index-content').scrollTo($(".comments .comment.marked"), 300, {
                    offset: -50
                });
            }
        }

        // 滚动到顶部
        function s2t() {
            $('html, body, .ad-index-content').scrollTo(0, 300);
        }

        // 滚动到底部
        function s2b() {

            if (isS2bFirst) { // 解决页面首次加载, 有图片加载比较慢导致没有滚动到顶部问题.
                isS2bFirst = false;
                Utils.imgLoaded($('.chat .ui.comments .comment .text img'), function() {
                    $('html, body, .ad-index-content').scrollTo({
                        left: 0,
                        top: "100%"
                    }, 300);
                });
            } else {
                $('html, body, .ad-index-content').scrollTo({
                    left: 0,
                    top: "100%"
                }, 300);
            }
        }

        /**
         * chat 内容转换
         * @param  {[type]} chats 沟通消息数组
         * @return {[type]}       返回模板编译后的jquery dom
         */
        function convertChat(chats) {
            var isAdminRole = $('input:hidden[name="role.admin"]').val();
            var loginUsername = $('input:hidden[name="user.username"]').val();
            $.each(chats, function(index, chat) {
                chat.contentMd = simplemde.markdown(preParse(chat.content));
                chat.marked = '';
                chat.zanCount = (chat.voteZan) ? chat.voteZan.split(',').length : 0;
                chat.caiCount = (chat.voteCai) ? chat.voteCai.split(',').length : 0;
                if (chat.creator.name) {
                    chat.creator.iconName = chat.creator.name.substr(chat.creator.name.length - 1).toUpperCase();
                }
                if (isAdminRole == 'true' || loginUsername == chat.creator.username) {
                    chat.actions = true;
                }
                var d = new Date(chat.createDate);
                chat.createDateFormat = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
            });
            var $more = $("#chatMoreTpl").tmpl(chats);
            $more.find('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });

            return $more;
        }

        $('.btn-chat-submit').click(function(event) {
            event.preventDefault();
            var content = simplemde.value();
            if (!$.trim(content)) {
                toastr.error('提交内容不能为空!');
                return;
            }
            var html = $('<div class="markdown-body"/>').html('<style>.markdown-body{font-size:14px;line-height:1.6}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a.absent{color:#C00}.markdown-body a.anchor{bottom:0;cursor:pointer;display:block;left:0;margin-left:-30px;padding-left:30px;position:absolute;top:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{cursor:text;font-weight:700;margin:20px 0 10px;padding:0;position:relative}.markdown-body h1 .mini-icon-link,.markdown-body h2 .mini-icon-link,.markdown-body h3 .mini-icon-link,.markdown-body h4 .mini-icon-link,.markdown-body h5 .mini-icon-link,.markdown-body h6 .mini-icon-link{color:#000;display:none}.markdown-body h1:hover a.anchor,.markdown-body h2:hover a.anchor,.markdown-body h3:hover a.anchor,.markdown-body h4:hover a.anchor,.markdown-body h5:hover a.anchor,.markdown-body h6:hover a.anchor{line-height:1;margin-left:-22px;padding-left:0;text-decoration:none;top:15%}.markdown-body h1:hover a.anchor .mini-icon-link,.markdown-body h2:hover a.anchor .mini-icon-link,.markdown-body h3:hover a.anchor .mini-icon-link,.markdown-body h4:hover a.anchor .mini-icon-link,.markdown-body h5:hover a.anchor .mini-icon-link,.markdown-body h6:hover a.anchor .mini-icon-link{display:inline-block}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{color:#000;font-size:28px}.markdown-body h2{border-bottom:1px solid #CCC;color:#000;font-size:24px}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h6{color:#777;font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:15px 0}.markdown-body hr{overflow:hidden;background:#e7e7e7;height:4px;padding:0;margin:16px 0;border:0;-moz-box-sizing:content-box;box-sizing:content-box}.markdown-body h1+p,.markdown-body h2+p,.markdown-body h3+p,.markdown-body h4+p,.markdown-body h5+p,.markdown-body h6+p,.markdown-body ol li>:first-child,.markdown-body ul li>:first-child{margin-top:0}.markdown-body hr:after{clear:both}.markdown-body a:first-child h1,.markdown-body a:first-child h2,.markdown-body a:first-child h3,.markdown-body a:first-child h4,.markdown-body a:first-child h5,.markdown-body a:first-child h6,.markdown-body>h1:first-child,.markdown-body>h1:first-child+h2,.markdown-body>h2:first-child,.markdown-body>h3:first-child,.markdown-body>h4:first-child,.markdown-body>h5:first-child,.markdown-body>h6:first-child{margin-top:0;padding-top:0}.markdown-body li p.first{display:inline-block}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol.no-list,.markdown-body ul.no-list{list-style-type:none;padding:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0}.markdown-body dl{padding:0}.markdown-body dl dt{font-size:14px;font-style:italic;font-weight:700;margin:15px 0 5px;padding:0}.markdown-body dl dt:first-child{padding:0}.markdown-body dl dt>:first-child{margin-top:0}.markdown-body dl dt>:last-child{margin-bottom:0}.markdown-body dl dd{margin:0 0 15px;padding:0 15px}.markdown-body blockquote>:first-child,.markdown-body dl dd>:first-child{margin-top:0}.markdown-body blockquote>:last-child,.markdown-body dl dd>:last-child{margin-bottom:0}.markdown-body blockquote{border-left:4px solid #DDD;color:#777;padding:0 15px}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{border:1px solid #CCC;padding:6px 13px}.markdown-body table tr{background-color:#FFF;border-top:1px solid #CCC}.markdown-body table tr:nth-child(2n){background-color:#F8F8F8}.markdown-body img{max-width:100%}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{border:1px solid #DDD;display:block;float:left;margin:13px 0 0;overflow:hidden;padding:7px;width:auto}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}.markdown-body span.align-center{clear:both;display:block;overflow:hidden}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{clear:both;display:block;overflow:hidden}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{background-color:#F8F8F8;border:1px solid #EAEAEA;border-radius:3px;margin:0 2px;padding:0 5px;white-space:nowrap}.markdown-body pre>code{background:none;border:none;margin:0;padding:0;white-space:pre}.markdown-body .highlight pre,.markdown-body pre{background-color:#F8F8F8;border:1px solid #CCC;border-radius:3px;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px}.markdown-body pre code,.markdown-body pre tt{background-color:transparent;border:none}</style>' + simplemde.markdown(preParse(content))).wrap('<div/>').parent().html();

            var preMore = $('.btn-chat-pre-more').size() == 1;
            var $last = $('.chat .comments .comment').last();

            var $domBefore = preMore ? $('.btn-chat-pre-more') : $('.fm-reply');

            $.post('/admin/chat/create', {
                preMore: preMore,
                lastId: $last.size() == 0 ? -1 : $('.chat .comments .comment').last().attr('data-id'),
                baseURL: baseURL,
                usernames: parseUsernames(content).join(','),
                content: content,
                contentHtml: html,
            }, function(data, textStatus, xhr) {
                if (data.success) {

                    simplemde.value('');
                    simplemde.autosave();
                    toastr.success('提交成功!');

                    window.poll.reset(); // 重置轮询频率

                    if ($.isArray(data.data)) { // 不刷新追加
                        if (data.data.length == 0) {
                            return;
                        }

                        var $more = convertChat(data.data);
                        $more.insertBefore($domBefore);
                        s2b();
                    } else {
                        window.location.href = url('path') + '?scroll=1';
                    }

                } else {
                    toastr.error(data.data, '提交失败!');
                }
            });
        });

        $('.btn-chat-clear').click(function(event) {
            event.preventDefault();
            simplemde.clearAutosavedValue();
            simplemde.value('');
        });

        $('body').on('click', '.comments .actions a.reply', function(event) {
            event.preventDefault();
            $btn = $(this);
            var id = $btn.closest('.comment').attr('data-id');
            var username = $btn.closest('.comment').find('.content .author').attr('data-value');

            // [[回复#10](admin/dynamic?id=1){~xiweicheng}]
            var comment = '[[回复#{id}]({baseURL}admin/dynamic?id={id}){~{username}}]\n\n';
            comment = comment.replace(/\{id\}/g, id)
                .replace(/\{baseURL\}/g, baseURL)
                .replace(/\{username\}/g, username);
            insertComment(cm, comment);

        });

        $('body').on('click', '.comments .actions a.delete', function(event) {
            $btn = $(this);
            $('.ad-delete-confirm').modal({
                onApprove: function() {
                    $.post('/admin/chat/delete', {
                        id: $btn.closest('.comment').attr('data-id')
                    }, function(data, textStatus, xhr) {
                        if (data.success) {
                            $btn.closest('.comment').remove();
                            toastr.success('删除成功!');
                        } else {
                            toastr.error(data.data, '删除失败!');
                        }
                    });
                }
            }).modal('show');
        });

        $('body').on('click', '.comments .actions a.edit', function(event) {
            $btn = $(this);

            $.get('/admin/chat/get', {
                id: $btn.closest('.comment').attr('data-id')
            }, function(data) {
                if (data.success) {

                    var contentOld = data.data.content;

                    $('.ad-chat-edit').modal({
                        onShow: function() {
                            simplemdeEdit.value(data.data.content);
                        },
                        onApprove: function() {
                            if (!simplemdeEdit.value()) {
                                toastr.error('更新内容不能为空!');
                                return false;
                            }

                            var content = simplemdeEdit.value();
                            var htmlOld = $('<div class="markdown-body"/>').html('<style>.markdown-body{font-size:14px;line-height:1.6}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a.absent{color:#C00}.markdown-body a.anchor{bottom:0;cursor:pointer;display:block;left:0;margin-left:-30px;padding-left:30px;position:absolute;top:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{cursor:text;font-weight:700;margin:20px 0 10px;padding:0;position:relative}.markdown-body h1 .mini-icon-link,.markdown-body h2 .mini-icon-link,.markdown-body h3 .mini-icon-link,.markdown-body h4 .mini-icon-link,.markdown-body h5 .mini-icon-link,.markdown-body h6 .mini-icon-link{color:#000;display:none}.markdown-body h1:hover a.anchor,.markdown-body h2:hover a.anchor,.markdown-body h3:hover a.anchor,.markdown-body h4:hover a.anchor,.markdown-body h5:hover a.anchor,.markdown-body h6:hover a.anchor{line-height:1;margin-left:-22px;padding-left:0;text-decoration:none;top:15%}.markdown-body h1:hover a.anchor .mini-icon-link,.markdown-body h2:hover a.anchor .mini-icon-link,.markdown-body h3:hover a.anchor .mini-icon-link,.markdown-body h4:hover a.anchor .mini-icon-link,.markdown-body h5:hover a.anchor .mini-icon-link,.markdown-body h6:hover a.anchor .mini-icon-link{display:inline-block}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{color:#000;font-size:28px}.markdown-body h2{border-bottom:1px solid #CCC;color:#000;font-size:24px}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h6{color:#777;font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:15px 0}.markdown-body hr{overflow:hidden;background:#e7e7e7;height:4px;padding:0;margin:16px 0;border:0;-moz-box-sizing:content-box;box-sizing:content-box}.markdown-body h1+p,.markdown-body h2+p,.markdown-body h3+p,.markdown-body h4+p,.markdown-body h5+p,.markdown-body h6+p,.markdown-body ol li>:first-child,.markdown-body ul li>:first-child{margin-top:0}.markdown-body hr:after{clear:both}.markdown-body a:first-child h1,.markdown-body a:first-child h2,.markdown-body a:first-child h3,.markdown-body a:first-child h4,.markdown-body a:first-child h5,.markdown-body a:first-child h6,.markdown-body>h1:first-child,.markdown-body>h1:first-child+h2,.markdown-body>h2:first-child,.markdown-body>h3:first-child,.markdown-body>h4:first-child,.markdown-body>h5:first-child,.markdown-body>h6:first-child{margin-top:0;padding-top:0}.markdown-body li p.first{display:inline-block}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol.no-list,.markdown-body ul.no-list{list-style-type:none;padding:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0}.markdown-body dl{padding:0}.markdown-body dl dt{font-size:14px;font-style:italic;font-weight:700;margin:15px 0 5px;padding:0}.markdown-body dl dt:first-child{padding:0}.markdown-body dl dt>:first-child{margin-top:0}.markdown-body dl dt>:last-child{margin-bottom:0}.markdown-body dl dd{margin:0 0 15px;padding:0 15px}.markdown-body blockquote>:first-child,.markdown-body dl dd>:first-child{margin-top:0}.markdown-body blockquote>:last-child,.markdown-body dl dd>:last-child{margin-bottom:0}.markdown-body blockquote{border-left:4px solid #DDD;color:#777;padding:0 15px}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{border:1px solid #CCC;padding:6px 13px}.markdown-body table tr{background-color:#FFF;border-top:1px solid #CCC}.markdown-body table tr:nth-child(2n){background-color:#F8F8F8}.markdown-body img{max-width:100%}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{border:1px solid #DDD;display:block;float:left;margin:13px 0 0;overflow:hidden;padding:7px;width:auto}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}.markdown-body span.align-center{clear:both;display:block;overflow:hidden}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{clear:both;display:block;overflow:hidden}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{background-color:#F8F8F8;border:1px solid #EAEAEA;border-radius:3px;margin:0 2px;padding:0 5px;white-space:nowrap}.markdown-body pre>code{background:none;border:none;margin:0;padding:0;white-space:pre}.markdown-body .highlight pre,.markdown-body pre{background-color:#F8F8F8;border:1px solid #CCC;border-radius:3px;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px}.markdown-body pre code,.markdown-body pre tt{background-color:transparent;border:none}</style>' + simplemdeEdit.markdown(preParse(contentOld))).wrap('<div/>').parent().html();
                            var html = $('<div class="markdown-body"/>').html('<style>.markdown-body{font-size:14px;line-height:1.6}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a.absent{color:#C00}.markdown-body a.anchor{bottom:0;cursor:pointer;display:block;left:0;margin-left:-30px;padding-left:30px;position:absolute;top:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{cursor:text;font-weight:700;margin:20px 0 10px;padding:0;position:relative}.markdown-body h1 .mini-icon-link,.markdown-body h2 .mini-icon-link,.markdown-body h3 .mini-icon-link,.markdown-body h4 .mini-icon-link,.markdown-body h5 .mini-icon-link,.markdown-body h6 .mini-icon-link{color:#000;display:none}.markdown-body h1:hover a.anchor,.markdown-body h2:hover a.anchor,.markdown-body h3:hover a.anchor,.markdown-body h4:hover a.anchor,.markdown-body h5:hover a.anchor,.markdown-body h6:hover a.anchor{line-height:1;margin-left:-22px;padding-left:0;text-decoration:none;top:15%}.markdown-body h1:hover a.anchor .mini-icon-link,.markdown-body h2:hover a.anchor .mini-icon-link,.markdown-body h3:hover a.anchor .mini-icon-link,.markdown-body h4:hover a.anchor .mini-icon-link,.markdown-body h5:hover a.anchor .mini-icon-link,.markdown-body h6:hover a.anchor .mini-icon-link{display:inline-block}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{color:#000;font-size:28px}.markdown-body h2{border-bottom:1px solid #CCC;color:#000;font-size:24px}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h6{color:#777;font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:15px 0}.markdown-body hr{overflow:hidden;background:#e7e7e7;height:4px;padding:0;margin:16px 0;border:0;-moz-box-sizing:content-box;box-sizing:content-box}.markdown-body h1+p,.markdown-body h2+p,.markdown-body h3+p,.markdown-body h4+p,.markdown-body h5+p,.markdown-body h6+p,.markdown-body ol li>:first-child,.markdown-body ul li>:first-child{margin-top:0}.markdown-body hr:after{clear:both}.markdown-body a:first-child h1,.markdown-body a:first-child h2,.markdown-body a:first-child h3,.markdown-body a:first-child h4,.markdown-body a:first-child h5,.markdown-body a:first-child h6,.markdown-body>h1:first-child,.markdown-body>h1:first-child+h2,.markdown-body>h2:first-child,.markdown-body>h3:first-child,.markdown-body>h4:first-child,.markdown-body>h5:first-child,.markdown-body>h6:first-child{margin-top:0;padding-top:0}.markdown-body li p.first{display:inline-block}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol.no-list,.markdown-body ul.no-list{list-style-type:none;padding:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0}.markdown-body dl{padding:0}.markdown-body dl dt{font-size:14px;font-style:italic;font-weight:700;margin:15px 0 5px;padding:0}.markdown-body dl dt:first-child{padding:0}.markdown-body dl dt>:first-child{margin-top:0}.markdown-body dl dt>:last-child{margin-bottom:0}.markdown-body dl dd{margin:0 0 15px;padding:0 15px}.markdown-body blockquote>:first-child,.markdown-body dl dd>:first-child{margin-top:0}.markdown-body blockquote>:last-child,.markdown-body dl dd>:last-child{margin-bottom:0}.markdown-body blockquote{border-left:4px solid #DDD;color:#777;padding:0 15px}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{border:1px solid #CCC;padding:6px 13px}.markdown-body table tr{background-color:#FFF;border-top:1px solid #CCC}.markdown-body table tr:nth-child(2n){background-color:#F8F8F8}.markdown-body img{max-width:100%}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{border:1px solid #DDD;display:block;float:left;margin:13px 0 0;overflow:hidden;padding:7px;width:auto}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}.markdown-body span.align-center{clear:both;display:block;overflow:hidden}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{clear:both;display:block;overflow:hidden}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{background-color:#F8F8F8;border:1px solid #EAEAEA;border-radius:3px;margin:0 2px;padding:0 5px;white-space:nowrap}.markdown-body pre>code{background:none;border:none;margin:0;padding:0;white-space:pre}.markdown-body .highlight pre,.markdown-body pre{background-color:#F8F8F8;border:1px solid #CCC;border-radius:3px;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px}.markdown-body pre code,.markdown-body pre tt{background-color:transparent;border:none}</style>' + simplemdeEdit.markdown(preParse(content))).wrap('<div/>').parent().html();

                            $.post('/admin/chat/update', {
                                id: $btn.closest('.comment').attr('data-id'),
                                baseURL: baseURL,
                                usernames: parseUsernames(content).join(','),
                                content: content,
                                contentHtmlOld: htmlOld,
                                contentHtml: html,
                            }, function(data, textStatus, xhr) {
                                if (data.success) {
                                    $btn.closest('.comment').find('.content .text.markdown-body').html(simplemdeEdit.markdown(preParse(simplemdeEdit.value())));
                                    toastr.success('更新成功!');
                                } else {
                                    toastr.error(data.data, '更新失败!');
                                }
                            });
                        }
                    }).modal('show');
                } else {
                    toastr.error(data.data, '获取失败!');
                }
            });
        });

        $('body').on('click', '.chat .comments .comment .content .author, .ui.comments .comment .text span.at-user, .pp-translate .ui.items>.item>.content>.description span.at-user, .fd-dynamic .event .content .summary .user', function(event) {
            event.preventDefault();
            insertAtUser(cm, $(this).attr('data-value'));
            s2b();
            cm.focus();
        });

        $('body').on('click', '.btn-chat-more', function(event) {
            event.preventDefault();

            $btn = $(this);

            $.get('/admin/chat/more', {
                page: $('input:hidden[name="page.number.next"]').val(),
                size: $('input:hidden[name="page.size"]').val()
            }, function(data) {
                if (data.success) {

                    if (data.data.content.length == 0) {
                        toastr.warning('没有更多数据了!');
                        return;
                    }

                    $('input:hidden[name="page.number.next"]').val(data.data.number + 1);
                    $('input:hidden[name="page.size"]').val(data.data.size);

                    var $more = convertChat(data.data.content);

                    $more.insertAfter($('.btn-chat-more'));
                    data.data.last && $btn.remove();
                    toastr.success('加载成功!');
                } else {
                    toastr.error(data.data, '加载失败!');
                }
            });
        });

        $('body').on('click', '.btn-chat-pre-more', function(event) {
            event.preventDefault();

            $btn = $(this);

            $.get('/admin/chat/more', {
                page: $('input:hidden[name="page.number.pre"]').val(),
                size: $('input:hidden[name="page.size"]').val()
            }, function(data) {
                if (data.success) {

                    if (data.data.content.length == 0) {
                        toastr.warning('没有更多数据了!');
                        return;
                    }

                    $('input:hidden[name="page.number.pre"]').val(data.data.number - 1);
                    $('input:hidden[name="page.size"]').val(data.data.size);

                    var $more = convertChat(data.data.content);
                    $more.insertBefore($('.btn-chat-pre-more'));

                    data.data.first && $btn.remove();
                    toastr.success('加载成功!');
                } else {
                    toastr.error(data.data, '加载失败!');
                }
            });
        });

        var actionMapping = {
            'Create': '创建',
            'Update': '更新',
            "Delete": '删除'
        };
        var propMapping = {
            'TranslateItem': '内容',
            'Key': '名称',
            'Watchers': '关注者',
            'Labels': '标签'
        };

        $('.btn-log-more').click(function(event) {
            $btn = $(this);

            $.get('/admin/chat/moreLogs', {
                page: $('input:hidden[name="page.number.next.logs"]').val(),
                size: $('input:hidden[name="page.size.logs"]').val()
            }, function(data) {
                if (data.success) {

                    if (data.data.content.length == 0) {
                        toastr.warning('没有更多数据了!');
                        return;
                    }

                    $('input:hidden[name="page.number.next.logs"]').val(data.data.number + 1);
                    $('input:hidden[name="page.size.logs"]').val(data.data.size);

                    $.each(data.data.content, function(index, log) {
                        if (log.creator.name) {
                            log.creator.iconName = log.creator.name.substr(log.creator.name.length - 1).toUpperCase();
                        }
                        if (log.properties == 'Labels') log.isLabels = true;
                        if (log.properties == 'Watchers') log.isWatchers = true;

                        log.actionMapping = actionMapping[log.action];
                        log.propertiesMapping = propMapping[log.properties];
                        var d = new Date(log.createDate);
                        log.createDate = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                    });
                    $("#logMoreTpl").tmpl(data.data.content).appendTo('.fd-dynamic');
                    data.data.last && $btn.remove();
                    toastr.success('加载成功!');
                } else {
                    toastr.error(data.data, '加载失败!');
                }
            });
        });

        $('.btn-get-chat-news').click(function(event) {
            event.preventDefault();
            $btn = $(this);
            $.get('/admin/chat/getNews', {
                lastId: $btn.attr('data-value')
            }, function(data) {
                if (data.success) {

                    $btn.hide();

                    if ($.isArray(data.data)) { // 不刷新追加
                        if (data.data.length == 0) {
                            return;
                        }

                        var preMore = $('.btn-chat-pre-more').size() == 1;
                        var $domBefore = preMore ? $('.btn-chat-pre-more') : $('.fm-reply');

                        var $more = convertChat(data.data);
                        $more.insertBefore($domBefore);
                        s2b();
                    }
                } else {
                    toastr.error(data.data, '获取失败!');
                }
            });
        });

        // $('.btn-get-chat-news').show();
        // 轮询最新沟通消息
        window.poll.start(function(resetCb, stopCb) {

            var preMore = $('.btn-chat-pre-more').size() == 1;

            if (preMore) { // 如果有最新消息有分页, 取消轮询.
                stopCb();
                return;
            }

            var $last = $('.chat .comments .comment').last();
            var $first = $('.fd-dynamic .event').first();

            $.get('/admin/chat/poll/unmask', {
                lastEvtId: $first.size() == 0 ? -1 : $first.attr('data-id'),
                lastId: $last.size() == 0 ? -1 : $last.attr('data-id')
            }, function(data) {
                if (data.success) {

                    if (data.data[1] > 0) {
                        resetCb();
                        $('.btn-get-chat-news').children('.lbl-chat-news-count').text(data.data[1]);
                        $('.btn-get-chat-news').attr('data-value', data.data[0]).show();
                    } else {
                        $('.btn-get-chat-news').attr('data-value', data.data[0]).hide();
                    }

                    if (data.msgs.length > 0) {

                        if (data.msgs[0].length > 0) {
                            resetCb();
                            $.each(data.msgs[0], function(index, log) {
                                if (log.creator.name) {
                                    log.creator.iconName = log.creator.name.substr(log.creator.name.length - 1).toUpperCase();
                                }
                                if (log.properties == 'Labels') log.isLabels = true;
                                if (log.properties == 'Watchers') log.isWatchers = true;

                                log.actionMapping = actionMapping[log.action];
                                log.propertiesMapping = propMapping[log.properties];
                                var d = new Date(log.createDate);
                                log.createDate = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                            });
                            $("#logMoreTpl").tmpl(data.msgs[0]).prependTo('.fd-dynamic');

                            var $toast = toastr.info('刚刚有' + data.msgs.length + '条动态更新');
                            $toast.click(function(event) {
                                event.preventDefault();
                                $('.main.container .right.rail .sticky').scrollTo(0, 300);
                                $toast.remove();
                            });
                        }

                    }

                }
            }).fail(function() {
                stopCb();
                toastr.error("请刷新浏览器,重新尝试!", "网络链接错误!", {
                    "closeButton": true,
                    "preventDuplicates": true,
                    "timeOut": "0"
                });
            });
        });

        // clipboard paste image
        $('.fm-reply .CodeMirror textarea').pastableTextarea().on('pasteImage', function(ev, data) {

            $.post('/admin/file/base64', {
                dataURL: data.dataURL,
                type: data.blob.type
            }, function(data, textStatus, xhr) {
                if (data.success) {
                    console.log(data);
                    insertComment(cm, '![{name}]({baseURL}{path}{uuidName})'
                        .replace(/\{name\}/g, data.data.name)
                        .replace(/\{baseURL\}/g, baseURL)
                        .replace(/\{path\}/g, data.data.path)
                        .replace(/\{uuidName\}/g, data.data.uuidName));
                }
            });
        }).on('pasteImageError', function(ev, data) {
            toastr.error(data.message, '剪贴板粘贴图片错误!');
        });

        // 翻译popup
        $('body').on('mouseover', '#context .chat a[href*="admin/translate"]:not(.pp-not)', function(event) {
            event.preventDefault();
            var $a = $(this);

            if ($a.closest('.pp-translate').size() != 0) {
                return;
            }

            if (!url('?id', $a.attr('href'))) {
                return;
            }

            $(this).popup({
                popup: $('.pp-translate'),
                hoverable: true,
                // context: 'body',
                // inline: true,
                // movePopup: false,
                // position: 'bottom center',
                delay: {
                    show: 300,
                    hide: 300
                },
                onShow: function() {
                    var $pp = $(this).html('加载中...');
                    // $pp.dimmer('show');
                    $.get('admin/translate/getById/unmask', {
                        id: url('?id', $a.attr('href'))
                    }, function(data) {
                        // $pp.dimmer('hide');
                        if (data.success) {
                            var translate = data.data;
                            var d = new Date(translate.createDate);
                            translate.createDateFormat = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                            $("#tansPpTpl").tmpl(data.data).appendTo($pp.empty());
                        } else {
                            toastr.error(data.data, "加载失败!");
                        }
                    });
                }
            }).popup('show');
        });

        // 消息popup
        $('body').on('mouseover', '#context .chat a[href*="admin/dynamic"]:not(.pp-not)', function(event) {
            event.preventDefault();
            var $a = $(this);

            if ($a.closest('.pp-translate').size() != 0) {
                return;
            }

            $(this).popup({
                popup: $('.pp-translate'),
                hoverable: true,
                // context: 'body',
                // inline: true,
                // movePopup: false,
                // position: 'bottom center',
                delay: {
                    show: 300,
                    hide: 300
                },
                onShow: function() {
                    var $pp = $(this).html('加载中...');
                    // $pp.dimmer('show');
                    $.get('admin/chat/get/unmask', {
                        id: url('?id', $a.attr('href'))
                    }, function(data) {
                        // $pp.dimmer('hide');
                        if (data.success) {
                            var chat = data.data;
                            chat.creatorName = chat.creator.name ? chat.creator.name : chat.creator.username;
                            var d = new Date(chat.createDate);
                            chat.createDateFormat = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                            chat.contentMd = simplemde.markdown(preParse(chat.content));

                            $("#chatMsgPpTpl").tmpl(data.data).appendTo($pp.empty());
                        } else {
                            toastr.error(data.data, "加载失败!");
                        }
                    });
                }
            }).popup('show');
        });

    });
    </script>
</body>

</html>
